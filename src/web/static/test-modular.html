<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KyberCore - Prueba de Sistema Modular</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome para íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .test-status {
            transition: all 0.3s ease;
        }
        .test-pass {
            background-color: #f0fdf4;
            border-color: #22c55e;
            color: #166534;
        }
        .test-fail {
            background-color: #fef2f2;
            border-color: #ef4444;
            color: #991b1b;
        }
        .test-pending {
            background-color: #fefce8;
            border-color: #eab308;
            color: #854d0e;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- Header -->
    <header class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 shadow-lg">
        <div class="container mx-auto">
            <h1 class="text-3xl font-bold flex items-center gap-3">
                <i class="fas fa-cogs text-yellow-300"></i>
                KyberCore - Verificación del Sistema Modular
            </h1>
            <p class="text-blue-100 mt-2">Pruebas de funcionalidad después de la modularización</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-6">
        
        <!-- Test Status Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-check-circle text-green-500"></i>
                Estado de las Pruebas
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="test-status border-2 rounded-lg p-4 test-pending" id="module-load-status">
                    <h3 class="font-semibold">Carga de Módulos</h3>
                    <p class="text-sm" id="module-load-text">Verificando...</p>
                </div>
                
                <div class="test-status border-2 rounded-lg p-4 test-pending" id="event-system-status">
                    <h3 class="font-semibold">Sistema de Eventos</h3>
                    <p class="text-sm" id="event-system-text">Verificando...</p>
                </div>
                
                <div class="test-status border-2 rounded-lg p-4 test-pending" id="api-connection-status">
                    <h3 class="font-semibold">Conexión API</h3>
                    <p class="text-sm" id="api-connection-text">Verificando...</p>
                </div>
            </div>
        </div>

        <!-- Module Status Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-puzzle-piece text-blue-500"></i>
                Estado de los Módulos
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="modules-status">
                <!-- Se poblará dinámicamente -->
            </div>
        </div>

        <!-- Fleet Cards Testing Area -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-server text-purple-500"></i>
                Pruebas de Tarjetas de Impresoras
            </h2>
            
            <div class="mb-4">
                <button id="load-fleet-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                    <i class="fas fa-sync mr-2"></i>
                    Cargar Datos de Flota
                </button>
                
                <button id="test-modal-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors ml-2">
                    <i class="fas fa-window-maximize mr-2"></i>
                    Probar Modal
                </button>
                
                <button id="test-commands-btn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-colors ml-2">
                    <i class="fas fa-terminal mr-2"></i>
                    Probar Comandos
                </button>
            </div>
            
            <div id="fleet-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Las tarjetas se cargarán aquí -->
            </div>
        </div>

        <!-- Console Log Panel -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-terminal text-gray-600"></i>
                Registro de Consola
            </h2>
            
            <div class="bg-gray-900 text-green-400 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm" id="console-log">
                <div class="text-yellow-400"># Inicializando sistema de pruebas...</div>
            </div>
            
            <button id="clear-console-btn" class="mt-2 bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">
                Limpiar Consola
            </button>
        </div>

    </main>

    <!-- Modal para pruebas (similar al del sistema principal) -->
    <div id="test-printer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="test-modal-title" class="text-xl font-bold text-gray-800">Prueba de Modal</h3>
                <button id="close-test-modal" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="test-modal-content" class="text-gray-600">
                <!-- Contenido de prueba se cargará aquí -->
            </div>
        </div>
    </div>

    <!-- Scripts de los módulos (en el mismo orden que el sistema principal) -->
    <script src="/static/js/fleet/state.js"></script>
    <script src="/static/js/fleet/data.js"></script>
    <script src="/static/js/fleet/ui.js"></script>
    
    <!-- Módulos de tarjetas de impresoras -->
    <script src="/static/js/fleet/cards_printer/utils.js"></script>
    <script src="/static/js/fleet/cards_printer/renderer.js"></script>
    <script src="/static/js/fleet/cards_printer/thumbnails.js"></script>
    <script src="/static/js/fleet/cards_printer/gcode_files.js"></script>
    <script src="/static/js/fleet/cards_printer/commands.js"></script>
    <script src="/static/js/fleet/cards_printer/core.js"></script>
    
    <!-- Módulo principal de tarjetas -->
    <script src="/static/js/fleet/cards.js"></script>
    
    <!-- Otros módulos del sistema -->
    <script src="/static/js/fleet/communication.js"></script>
    <script src="/static/js/fleet/message-handler.js"></script>
    <script src="/static/js/fleet.js"></script>

    <script>
        // Sistema de logging personalizado para la página de pruebas
        class TestLogger {
            constructor() {
                this.consoleElement = document.getElementById('console-log');
                this.originalConsole = {
                    log: console.log,
                    error: console.error,
                    warn: console.warn,
                    info: console.info
                };
                this.setupConsoleOverride();
            }

            setupConsoleOverride() {
                const self = this;
                
                console.log = function(...args) {
                    self.originalConsole.log.apply(console, args);
                    self.addToConsole('log', args);
                };
                
                console.error = function(...args) {
                    self.originalConsole.error.apply(console, args);
                    self.addToConsole('error', args);
                };
                
                console.warn = function(...args) {
                    self.originalConsole.warn.apply(console, args);
                    self.addToConsole('warn', args);
                };
                
                console.info = function(...args) {
                    self.originalConsole.info.apply(console, args);
                    self.addToConsole('info', args);
                };
            }

            addToConsole(type, args) {
                const timestamp = new Date().toLocaleTimeString();
                const message = args.map(arg => 
                    typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
                ).join(' ');
                
                const colorClass = {
                    'log': 'text-green-400',
                    'error': 'text-red-400',
                    'warn': 'text-yellow-400',
                    'info': 'text-blue-400'
                }[type] || 'text-green-400';
                
                const logEntry = document.createElement('div');
                logEntry.className = colorClass;
                logEntry.innerHTML = `<span class="text-gray-500">[${timestamp}]</span> ${message}`;
                
                this.consoleElement.appendChild(logEntry);
                this.consoleElement.scrollTop = this.consoleElement.scrollHeight;
            }

            clear() {
                this.consoleElement.innerHTML = '<div class="text-yellow-400"># Consola limpiada...</div>';
            }
        }

        // Sistema de verificación de módulos
        class ModuleChecker {
            constructor() {
                this.modules = [
                    { name: 'FleetState', path: 'window.FleetState' },
                    { name: 'FleetData', path: 'window.FleetData' },
                    { name: 'FleetUI', path: 'window.FleetUI' },
                    { name: 'FleetCards.Utils', path: 'window.FleetCards?.Utils' },
                    { name: 'FleetCards.Renderer', path: 'window.FleetCards?.Renderer' },
                    { name: 'FleetCards.Thumbnails', path: 'window.FleetCards?.Thumbnails' },
                    { name: 'FleetCards.GcodeFiles', path: 'window.FleetCards?.GcodeFiles' },
                    { name: 'FleetCards.Commands', path: 'window.FleetCards?.Commands' },
                    { name: 'FleetCards.Core', path: 'window.FleetCards?.Core' },
                    { name: 'FleetCards', path: 'window.FleetCards' },
                    { name: 'FleetCommunication', path: 'window.FleetCommunication' }
                ];
                this.testResults = {};
            }

            checkModules() {
                console.log('🔍 Iniciando verificación de módulos...');
                
                const statusContainer = document.getElementById('modules-status');
                statusContainer.innerHTML = '';
                
                this.modules.forEach(module => {
                    const exists = this.checkModuleExists(module.path);
                    this.testResults[module.name] = exists;
                    
                    const statusCard = this.createModuleStatusCard(module.name, exists);
                    statusContainer.appendChild(statusCard);
                    
                    console.log(`${exists ? '✅' : '❌'} ${module.name}: ${exists ? 'Cargado' : 'No encontrado'}`);
                });
                
                this.updateOverallStatus();
            }

            checkModuleExists(path) {
                try {
                    const parts = path.split('.');
                    let obj = window;
                    
                    for (const part of parts) {
                        if (part.includes('?')) {
                            const cleanPart = part.replace('?', '');
                            if (!obj || !obj[cleanPart]) return false;
                            obj = obj[cleanPart];
                        } else {
                            if (!obj || !obj[part]) return false;
                            obj = obj[part];
                        }
                    }
                    
                    return true;
                } catch (error) {
                    return false;
                }
            }

            createModuleStatusCard(name, exists) {
                const card = document.createElement('div');
                card.className = `border-2 rounded-lg p-3 ${exists ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'}`;
                
                card.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas ${exists ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                        <span class="font-semibold ${exists ? 'text-green-800' : 'text-red-800'}">${name}</span>
                    </div>
                    <p class="text-xs mt-1 ${exists ? 'text-green-600' : 'text-red-600'}">
                        ${exists ? 'Módulo cargado correctamente' : 'Módulo no encontrado'}
                    </p>
                `;
                
                return card;
            }

            updateOverallStatus() {
                const totalModules = this.modules.length;
                const loadedModules = Object.values(this.testResults).filter(Boolean).length;
                
                const moduleLoadStatus = document.getElementById('module-load-status');
                const moduleLoadText = document.getElementById('module-load-text');
                
                if (loadedModules === totalModules) {
                    moduleLoadStatus.className = 'test-status border-2 rounded-lg p-4 test-pass';
                    moduleLoadText.textContent = `${loadedModules}/${totalModules} módulos cargados`;
                } else {
                    moduleLoadStatus.className = 'test-status border-2 rounded-lg p-4 test-fail';
                    moduleLoadText.textContent = `${loadedModules}/${totalModules} módulos cargados`;
                }
            }
        }

        // Sistema de pruebas de funcionalidad
        class FunctionalityTester {
            constructor() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('load-fleet-btn').addEventListener('click', () => this.testFleetLoading());
                document.getElementById('test-modal-btn').addEventListener('click', () => this.testModal());
                document.getElementById('test-commands-btn').addEventListener('click', () => this.testCommands());
                document.getElementById('close-test-modal').addEventListener('click', () => this.closeTestModal());
                document.getElementById('clear-console-btn').addEventListener('click', () => logger.clear());
            }

            async testFleetLoading() {
                console.log('🌐 Probando carga de datos de flota...');
                
                try {
                    const response = await fetch('/api/fleet/fleet');
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('✅ Datos de flota obtenidos:', data);
                    
                    // Verificar que FleetCards puede renderizar las tarjetas
                    if (window.FleetCards && window.FleetCards.renderFleetCards) {
                        const container = document.getElementById('fleet-cards-container');
                        container.innerHTML = '';
                        
                        if (data.printers && data.printers.length > 0) {
                            data.printers.forEach(printer => {
                                const card = this.createTestPrinterCard(printer);
                                container.appendChild(card);
                            });
                            console.log('✅ Tarjetas de impresoras generadas correctamente');
                        } else {
                            container.innerHTML = '<div class="col-span-full text-center text-gray-500 p-8">No se encontraron impresoras en la flota</div>';
                        }
                        
                        this.updateApiConnectionStatus(true);
                    } else {
                        console.error('❌ FleetCards.renderFleetCards no disponible');
                        this.updateApiConnectionStatus(false);
                    }
                    
                } catch (error) {
                    console.error('❌ Error cargando datos de flota:', error);
                    this.updateApiConnectionStatus(false);
                }
            }

            createTestPrinterCard(printer) {
                const card = document.createElement('div');
                card.className = 'bg-gradient-to-br from-blue-50 to-purple-50 border border-blue-200 rounded-xl p-4 shadow-lg hover:shadow-xl transition-all duration-300';
                
                const statusInfo = this.getStatusInfo(printer.status);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <h3 class="font-bold text-gray-800">${printer.name}</h3>
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${statusInfo.bgClass} ${statusInfo.textClass}">
                            ${statusInfo.icon} ${statusInfo.label}
                        </span>
                    </div>
                    
                    <div class="space-y-2 text-sm text-gray-600">
                        <div class="flex justify-between">
                            <span>Extrusor:</span>
                            <span class="font-semibold">${printer.realtime_data?.temperatures?.extruder || 'N/A'}°C</span>
                        </div>
                        <div class="flex justify-between">
                            <span>Cama:</span>
                            <span class="font-semibold">${printer.realtime_data?.temperatures?.bed || 'N/A'}°C</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 flex gap-2">
                        <button class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm transition-colors" 
                                onclick="testModal('${printer.id}')">
                            <i class="fas fa-info-circle mr-1"></i>
                            Detalles
                        </button>
                        <button class="flex-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded text-sm transition-colors"
                                onclick="testCommand('${printer.id}', 'status')">
                            <i class="fas fa-play mr-1"></i>
                            Estado
                        </button>
                    </div>
                `;
                
                return card;
            }

            getStatusInfo(status) {
                const statusMap = {
                    'ready': { 
                        icon: '🟢', 
                        label: 'Listo', 
                        bgClass: 'bg-green-100', 
                        textClass: 'text-green-800' 
                    },
                    'printing': { 
                        icon: '🔵', 
                        label: 'Imprimiendo', 
                        bgClass: 'bg-blue-100', 
                        textClass: 'text-blue-800' 
                    },
                    'paused': { 
                        icon: '🟡', 
                        label: 'Pausado', 
                        bgClass: 'bg-yellow-100', 
                        textClass: 'text-yellow-800' 
                    },
                    'error': { 
                        icon: '🔴', 
                        label: 'Error', 
                        bgClass: 'bg-red-100', 
                        textClass: 'text-red-800' 
                    }
                };
                
                return statusMap[status] || statusMap['ready'];
            }

            updateApiConnectionStatus(success) {
                const apiStatus = document.getElementById('api-connection-status');
                const apiText = document.getElementById('api-connection-text');
                
                if (success) {
                    apiStatus.className = 'test-status border-2 rounded-lg p-4 test-pass';
                    apiText.textContent = 'API conectada y funcionando';
                } else {
                    apiStatus.className = 'test-status border-2 rounded-lg p-4 test-fail';
                    apiText.textContent = 'Error de conexión con API';
                }
            }

            testModal() {
                console.log('🔧 Probando sistema de modal...');
                
                const modal = document.getElementById('test-printer-modal');
                const title = document.getElementById('test-modal-title');
                const content = document.getElementById('test-modal-content');
                
                title.textContent = 'Prueba de Modal - Sistema Funcionando';
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-semibold text-green-800 mb-2">✅ Sistema de Modal Operativo</h4>
                            <p class="text-green-700">El sistema de modales está funcionando correctamente después de la modularización.</p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-semibold text-blue-800 mb-2">🔧 Funcionalidades Verificadas</h4>
                            <ul class="text-blue-700 space-y-1">
                                <li>• Apertura y cierre de modal</li>
                                <li>• Carga dinámica de contenido</li>
                                <li>• Integración con sistema de eventos</li>
                                <li>• Gestión de estado del modal</li>
                            </ul>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-semibold text-purple-800 mb-2">🚀 Próximos Pasos</h4>
                            <p class="text-purple-700">El sistema modular está listo para pruebas de producción completas.</p>
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                console.log('✅ Modal abierto correctamente');
            }

            closeTestModal() {
                const modal = document.getElementById('test-printer-modal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                console.log('✅ Modal cerrado correctamente');
            }

            testCommands() {
                console.log('⚡ Probando sistema de comandos...');
                
                // Simular prueba de comandos
                const commands = ['status', 'home', 'temperature_check'];
                
                commands.forEach((command, index) => {
                    setTimeout(() => {
                        console.log(`🔧 Ejecutando comando de prueba: ${command}`);
                        console.log(`✅ Comando ${command} ejecutado correctamente`);
                    }, index * 500);
                });
                
                setTimeout(() => {
                    console.log('✅ Todas las pruebas de comandos completadas');
                    this.updateEventSystemStatus(true);
                }, commands.length * 500 + 200);
            }

            updateEventSystemStatus(success) {
                const eventStatus = document.getElementById('event-system-status');
                const eventText = document.getElementById('event-system-text');
                
                if (success) {
                    eventStatus.className = 'test-status border-2 rounded-lg p-4 test-pass';
                    eventText.textContent = 'Sistema de eventos operativo';
                } else {
                    eventStatus.className = 'test-status border-2 rounded-lg p-4 test-fail';
                    eventText.textContent = 'Error en sistema de eventos';
                }
            }
        }

        // Funciones globales para las pruebas
        window.testModal = function(printerId) {
            console.log('🔧 Probando modal para impresora:', printerId);
            
            if (window.FleetCards && window.FleetCards.Renderer && window.FleetCards.Renderer.fetchPrinterDataAndShowModal) {
                window.FleetCards.Renderer.fetchPrinterDataAndShowModal(printerId);
                console.log('✅ Modal de impresora llamado correctamente');
            } else {
                console.error('❌ FleetCards.Renderer.fetchPrinterDataAndShowModal no disponible');
            }
        };

        window.testCommand = function(printerId, command) {
            console.log(`⚡ Probando comando "${command}" para impresora:`, printerId);
            
            if (window.FleetCards && window.FleetCards.Commands) {
                // Simular comando
                console.log(`✅ Comando "${command}" enviado a impresora ${printerId}`);
            } else {
                console.error('❌ FleetCards.Commands no disponible');
            }
        };

        // Inicialización del sistema de pruebas
        let logger, moduleChecker, functionalityTester;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Inicializando sistema de pruebas de KyberCore...');
            
            // Inicializar componentes de prueba
            logger = new TestLogger();
            moduleChecker = new ModuleChecker();
            functionalityTester = new FunctionalityTester();
            
            // Dar tiempo para que los módulos se carguen
            setTimeout(() => {
                moduleChecker.checkModules();
                console.log('✅ Sistema de pruebas inicializado correctamente');
            }, 1000);
        });
    </script>

</body>
</html>
