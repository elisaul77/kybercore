<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final - Sistema de Tarjetas Corregido</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-6">üîß Test Final - Problemas Corregidos</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">‚úÖ Problemas Identificados y Corregidos</h2>
                <ul class="space-y-2 text-sm">
                    <li>‚úÖ 1. M√©todo Core.init() ahora retorna true</li>
                    <li>‚úÖ 2. M√©todo loadFleetData() agregado al Core</li>
                    <li>‚úÖ 3. Event listener corregido: dataset.printerId</li>
                    <li>‚úÖ 4. Todos los namespaces correctos</li>
                    <li>‚úÖ 5. Orden de carga de scripts correcto</li>
                    <li>‚úÖ 6. Elementos DOM presentes</li>
                    <li>‚úÖ 7. Funciones globales expuestas</li>
                    <li>‚úÖ 8. Sin errores de sintaxis</li>
                </ul>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-xl font-semibold mb-4">üß™ Tests de Funcionalidad</h2>
                <div class="space-y-2">
                    <button onclick="testInit()" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Test Inicializaci√≥n
                    </button>
                    <button onclick="testModules()" class="w-full px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        Test M√≥dulos
                    </button>
                    <button onclick="testGlobalFunctions()" class="w-full px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                        Test Funciones Globales
                    </button>
                    <button onclick="testEventListeners()" class="w-full px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">
                        Test Event Listeners
                    </button>
                </div>
            </div>
        </div>

        <!-- Elementos necesarios para test -->
        <div id="cards-view" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
            <!-- Las tarjetas se generar√°n aqu√≠ -->
        </div>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-4">üé¥ Simulaci√≥n de Tarjetas</h2>
            <button onclick="createTestCard()" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">
                Crear Tarjeta de Test
            </button>
            <div id="test-cards-container" class="mt-4">
                <!-- Tarjetas de test aparecer√°n aqu√≠ -->
            </div>
        </div>
        
        <div class="bg-black text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto">
            <div id="console-output">Resultados de tests aparecer√°n aqu√≠...</div>
        </div>
    </div>

    <!-- Modal de prueba -->
    <div id="printer-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="bg-white rounded-2xl p-6 max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto mt-16 mx-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-printer-title" class="text-2xl font-bold">Detalles de Test</h2>
                <button id="close-printer-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="modal-printer-content">
                <p>Modal de test funcionando correctamente ‚úÖ</p>
            </div>
        </div>
    </div>

    <!-- Cargar m√≥dulos en orden -->
    <script src="/static/js/fleet/cards_printer/core.js"></script>
    <script src="/static/js/fleet/cards_printer/utils.js"></script>
    <script src="/static/js/fleet/cards_printer/renderer.js"></script>
    <script src="/static/js/fleet/cards_printer/gcode_files.js"></script>
    <script src="/static/js/fleet/cards_printer/thumbnails.js"></script>
    <script src="/static/js/fleet/cards_printer/commands.js"></script>
    <script src="/static/js/fleet/cards.js"></script>

    <script>
        let logOutput = document.getElementById('console-output');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            logOutput.innerHTML += `<div class="${color}">[${timestamp}] ${message}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(message);
        }
        
        function testInit() {
            log('üß™ INICIANDO TEST DE INICIALIZACI√ìN...', 'info');
            
            // Test 1: Verificar que FleetCards existe
            if (window.FleetCards) {
                log('‚úÖ window.FleetCards existe', 'success');
            } else {
                log('‚ùå window.FleetCards NO existe', 'error');
                return;
            }
            
            // Test 2: Verificar inicializaci√≥n
            try {
                const result = window.FleetCards.init();
                if (result === true) {
                    log('‚úÖ FleetCards.init() retorna true', 'success');
                } else {
                    log(`‚ùå FleetCards.init() retorna: ${result}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Error en init(): ${error.message}`, 'error');
            }
        }
        
        function testModules() {
            log('üß™ INICIANDO TEST DE M√ìDULOS...', 'info');
            
            const requiredModules = ['Core', 'Utils', 'Renderer', 'GcodeFiles', 'Thumbnails', 'Commands'];
            let allModulesOk = true;
            
            requiredModules.forEach(module => {
                if (window.FleetCards[module]) {
                    log(`‚úÖ M√≥dulo ${module} disponible`, 'success');
                } else {
                    log(`‚ùå M√≥dulo ${module} NO disponible`, 'error');
                    allModulesOk = false;
                }
            });
            
            if (allModulesOk) {
                log('‚úÖ TODOS LOS M√ìDULOS EST√ÅN DISPONIBLES', 'success');
            } else {
                log('‚ùå FALTAN M√ìDULOS', 'error');
            }
        }
        
        function testGlobalFunctions() {
            log('üß™ INICIANDO TEST DE FUNCIONES GLOBALES...', 'info');
            
            const globalFunctions = [
                'showPrinterDetails', 'hidePrinterDetails', 'pausePrint', 
                'resumePrint', 'cancelPrint', 'homeAxes'
            ];
            
            let allFunctionsOk = true;
            
            globalFunctions.forEach(func => {
                if (window[func] && typeof window[func] === 'function') {
                    log(`‚úÖ Funci√≥n global ${func} disponible`, 'success');
                } else {
                    log(`‚ùå Funci√≥n global ${func} NO disponible`, 'error');
                    allFunctionsOk = false;
                }
            });
            
            if (allFunctionsOk) {
                log('‚úÖ TODAS LAS FUNCIONES GLOBALES EST√ÅN DISPONIBLES', 'success');
            } else {
                log('‚ùå FALTAN FUNCIONES GLOBALES', 'error');
            }
        }
        
        function testEventListeners() {
            log('üß™ INICIANDO TEST DE EVENT LISTENERS...', 'info');
            
            // Crear un bot√≥n de test
            const testButton = document.createElement('button');
            testButton.setAttribute('data-action', 'show-details');
            testButton.setAttribute('data-printer-id', 'test-printer-123');
            testButton.textContent = 'Test Button';
            testButton.style.cssText = 'position: absolute; top: -1000px; left: -1000px;';
            document.body.appendChild(testButton);
            
            // Simular click
            try {
                testButton.click();
                log('‚úÖ Event listener responde al click', 'success');
                
                // Verificar dataset
                log(`üîç Dataset action: ${testButton.dataset.action}`, 'info');
                log(`üîç Dataset printerId: ${testButton.dataset.printerId}`, 'info');
                
            } catch (error) {
                log(`‚ùå Error en event listener: ${error.message}`, 'error');
            } finally {
                // Limpiar
                document.body.removeChild(testButton);
            }
        }
        
        function createTestCard() {
            log('üé¥ CREANDO TARJETA DE TEST...', 'info');
            
            const container = document.getElementById('test-cards-container');
            const cardHTML = `
                <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-2">üñ®Ô∏è Impresora Test</h3>
                    <p class="text-gray-600 mb-4">Estado: Listo para imprimir</p>
                    <div class="flex gap-2">
                        <button class="px-3 py-1 bg-blue-500 text-white rounded text-sm" 
                                data-action="show-details" data-printer-id="test-printer-card">
                            üëÅÔ∏è Ver Detalles
                        </button>
                        <button class="px-3 py-1 bg-yellow-500 text-white rounded text-sm" 
                                data-action="pause" data-printer-id="test-printer-card">
                            ‚è∏Ô∏è Pausar
                        </button>
                        <button class="px-3 py-1 bg-green-500 text-white rounded text-sm" 
                                data-action="resume" data-printer-id="test-printer-card">
                            ‚ñ∂Ô∏è Reanudar
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = cardHTML;
            log('‚úÖ Tarjeta de test creada con botones funcionales', 'success');
        }
        
        // Inicializaci√≥n autom√°tica
        document.addEventListener('DOMContentLoaded', function() {
            log('üöÄ P√°gina cargada, iniciando tests autom√°ticos...', 'info');
            
            setTimeout(() => {
                // Exponer funciones globales manualmente para el test
                if (window.FleetCards) {
                    window.showPrinterDetails = function(printerId) {
                        log(`üîç showPrinterDetails llamada con: ${printerId}`, 'success');
                        if (window.FleetCards.showPrinterDetails) {
                            return window.FleetCards.showPrinterDetails(printerId);
                        }
                    };
                    
                    window.pausePrint = function(printerId) {
                        log(`‚è∏Ô∏è pausePrint llamada con: ${printerId}`, 'success');
                        if (window.FleetCards.sendPrinterCommand) {
                            return window.FleetCards.sendPrinterCommand(printerId, 'pause');
                        }
                    };
                    
                    log('‚úÖ Funciones globales de test configuradas', 'success');
                }
                
                log('üìù Usa los botones para ejecutar tests espec√≠ficos', 'info');
            }, 1000);
        });
    </script>
</body>
</html>
