<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Flujo de Impresi√≥n Completo - KyberCore</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 mb-8">üß™ Prueba del Flujo de Impresi√≥n Completo</h1>
        
        <!-- Proyecto de prueba -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ATX Power Supply - Proyecto de Prueba</h2>
            <div class="flex flex-wrap gap-2 mb-4">
                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">9 archivos STL</span>
                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">Listo para imprimir</span>
            </div>
            
            <button onclick="openTestPrintFlowWizard()" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                üöÄ Iniciar Flujo de Impresi√≥n
            </button>
        </div>
        
        <!-- Log de pruebas -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">üìã Log de Pruebas</h3>
            <div id="test-log" class="bg-gray-50 rounded p-4 h-64 overflow-y-auto text-sm font-mono">
                <div class="text-green-600">[INIT] Sistema de pruebas inicializado</div>
            </div>
        </div>
    </div>

    <!-- Modal del Wizard -->
    <div id="printFlowModal" class="fixed inset-0 modal-backdrop z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden">
            <!-- Header -->
            <div class="border-b border-gray-200 p-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-900">üñ®Ô∏è Asistente de Impresi√≥n</h2>
                    <button onclick="closePrintFlowWizard()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                </div>
                
                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span>Paso <span id="current-step-number">1</span> de 7</span>
                        <span id="step-name">Selecci√≥n de Piezas</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 14%"></div>
                    </div>
                </div>
            </div>
            
            <!-- Content -->
            <div id="wizard-content" class="p-6 overflow-y-auto max-h-[60vh]">
                <!-- Contenido din√°mico del step actual -->
            </div>
            
            <!-- Actions -->
            <div class="border-t border-gray-200 p-6 bg-gray-50">
                <div id="wizard-actions" class="flex justify-end space-x-3">
                    <button onclick="loadPrintFlowStep(null, null, 'piece_selection')" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        Seleccionar Piezas
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Mock data y configuraci√≥n
        const mockProjectData = {
            project_id: '1',
            project_name: 'ATX Power Supply',
            stl_files: [
                'Cover_USB.stl', 'back_frame.stl', 'front_cover_volt_amp_adj.stl',
                'front_cover_volt_ampmeter.stl', 'front_frame.stl', 'front_panel.stl',
                'handle.stl', 'rail_bottom.stl', 'rail_top.stl'
            ]
        };

        // Variables globales del wizard
        let currentWizardStep = 'piece_selection';
        let wizardData = {};

        // Funci√≥n para abrir el wizard de prueba
        function openTestPrintFlowWizard() {
            logTest('OPEN', 'Abriendo wizard de flujo de impresi√≥n');
            document.getElementById('printFlowModal').classList.remove('hidden');
            loadPrintFlowStep(null, null, 'piece_selection');
        }

        function closePrintFlowWizard() {
            logTest('CLOSE', 'Cerrando wizard de flujo de impresi√≥n');
            document.getElementById('printFlowModal').classList.add('hidden');
        }

        // Funci√≥n de logging para pruebas
        function logTest(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const log = document.getElementById('test-log');
            const colorClass = type === 'SUCCESS' ? 'text-green-600' : 
                              type === 'ERROR' ? 'text-red-600' : 
                              type === 'WARN' ? 'text-yellow-600' : 'text-blue-600';
            
            log.innerHTML += `<div class="${colorClass}">[${timestamp}] [${type}] ${message}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        // Sistema de toast simplificado para pruebas
        function showToast(title, message, type = 'info') {
            logTest(type.toUpperCase(), `${title}: ${message}`);
            
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            
            toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.innerHTML = `<div class="font-medium">${title}</div><div class="text-sm">${message}</div>`;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toastContainer.removeChild(toast), 300);
            }, 3000);
        }

        // Funci√≥n principal de navegaci√≥n del wizard
        async function loadPrintFlowStep(projectId, projectName, step, config = {}) {
            logTest('STEP', `Cargando paso: ${step}`);
            
            currentWizardStep = step;
            const stepInfo = getStepInfo(step);
            
            // Actualizar UI del header
            document.getElementById('current-step-number').textContent = stepInfo.number;
            document.getElementById('step-name').textContent = stepInfo.name;
            document.getElementById('progress-bar').style.width = `${(stepInfo.number / 7) * 100}%`;
            
            // Cargar contenido del paso
            try {
                let content = '';
                
                switch(step) {
                    case 'piece_selection':
                        content = await loadPieceSelectionStep();
                        break;
                    case 'material_selection':
                        content = await loadMaterialSelectionStep();
                        break;
                    case 'production_mode':
                        content = await loadProductionModeStep();
                        break;
                    case 'printer_assignment':
                        content = await loadPrinterAssignmentStep();
                        break;
                    case 'stl_processing':
                        content = await loadSTLProcessingStep();
                        break;
                    case 'validation':
                        content = await loadValidationStep();
                        break;
                    case 'confirmation':
                        content = await loadConfirmationStep();
                        break;
                    case 'monitoring':
                        content = await loadMonitoringStep();
                        break;
                    default:
                        content = '<div class="text-center text-gray-500">Paso no implementado</div>';
                }
                
                document.getElementById('wizard-content').innerHTML = content;
                logTest('SUCCESS', `Paso ${step} cargado correctamente`);
                
            } catch (error) {
                logTest('ERROR', `Error cargando paso ${step}: ${error.message}`);
                document.getElementById('wizard-content').innerHTML = `
                    <div class="text-center text-red-500">
                        <div class="text-lg">‚ùå Error</div>
                        <div>${error.message}</div>
                    </div>
                `;
            }
        }

        function getStepInfo(step) {
            const steps = {
                'piece_selection': { number: 1, name: 'Selecci√≥n de Piezas' },
                'material_selection': { number: 2, name: 'Selecci√≥n de Material' },
                'production_mode': { number: 3, name: 'Modo de Producci√≥n' },
                'printer_assignment': { number: 4, name: 'Asignaci√≥n de Impresora' },
                'stl_processing': { number: 5, name: 'Procesamiento STL' },
                'validation': { number: 6, name: 'Validaci√≥n' },
                'confirmation': { number: 7, name: 'Confirmaci√≥n' },
                'monitoring': { number: 8, name: 'Monitoreo' }
            };
            return steps[step] || { number: 1, name: 'Desconocido' };
        }

        // Mock fetch para simular API calls
        window.fetch = function(url, options = {}) {
            logTest('API', `${options.method || 'GET'} ${url}`);
            
            return new Promise((resolve) => {
                setTimeout(() => {
                    let mockResponse = { success: true };
                    
                    // Simular diferentes respuestas seg√∫n el endpoint
                    if (url.includes('/piece-selection')) {
                        mockResponse = {
                            success: true,
                            pieces: mockProjectData.stl_files.map((file, i) => ({
                                filename: file,
                                size: Math.floor(Math.random() * 500) + 100,
                                selected: i < 8 // Solo seleccionar 8 de 9
                            })),
                            next_step: { step: 'material_selection' }
                        };
                    } else if (url.includes('/material-selection')) {
                        mockResponse = {
                            success: true,
                            materials: [
                                { id: 1, tipo: 'PLA', color: 'Blanco', marca: 'eSUN', disponible: true, stock: 750 },
                                { id: 2, tipo: 'PLA', color: 'Negro', marca: 'eSUN', disponible: true, stock: 420 },
                                { id: 3, tipo: 'PETG', color: 'Transparente', marca: 'Prusament', disponible: false, stock: 0 }
                            ],
                            selected_material: { id: 1, tipo: 'PLA', color: 'Blanco', marca: 'eSUN' },
                            next_step: { step: 'production_mode' }
                        };
                    } else if (url.includes('/production-mode')) {
                        mockResponse = {
                            success: true,
                            available_modes: ['prototype', 'production', 'detailed'],
                            selected_mode: 'prototype',
                            settings: { layer_height: 0.3, infill_density: 15, print_speed: 80 },
                            next_step: { step: 'printer_assignment' }
                        };
                    } else if (url.includes('/assign-printer')) {
                        mockResponse = {
                            success: true,
                            assigned_printer: { id: 1, nombre: 'Impresora Prueba', estado: 'disponible' },
                            next_step: { step: 'stl_processing' }
                        };
                    } else if (url.includes('/process-stl')) {
                        mockResponse = {
                            success: true,
                            processed_files: mockProjectData.stl_files.slice(0, 8).map(file => ({
                                stl_file: file,
                                gcode_file: file.replace('.stl', '.gcode'),
                                estimated_time: Math.floor(Math.random() * 120) + 30,
                                filament_used: Math.floor(Math.random() * 20) + 5
                            })),
                            next_step: { step: 'validation' }
                        };
                    } else if (url.includes('/validation-report')) {
                        mockResponse = {
                            success: true,
                            validation: {
                                processing_summary: {
                                    successful: 8,
                                    total_files: 8,
                                    total_estimated_time_hours: 6.5,
                                    total_filament_grams: 110.7,
                                    estimated_cost: 2.77
                                },
                                validation_checks: {
                                    material_availability: { status: 'success', details: 'Material PLA disponible (750g)' },
                                    printer_status: { status: 'success', details: 'Impresora lista y calibrada' },
                                    file_integrity: { status: 'success', details: 'Todos los archivos G-code v√°lidos' },
                                    bed_size: { status: 'warning', details: 'Algunas piezas grandes - revisar orientaci√≥n' }
                                },
                                warnings: ['Pieza "handle.stl" podr√≠a beneficiarse de soportes'],
                                errors: [],
                                recommendations: ['Considerar agrupar piezas peque√±as', 'Revisar temperatura de primera capa']
                            }
                        };
                    } else if (url.includes('/confirm-job')) {
                        mockResponse = {
                            success: true,
                            job_confirmed: {
                                job_id: 'abc123-def456',
                                status: 'queued',
                                queue_position: 1,
                                estimated_start: 'immediate'
                            },
                            next_step: { step: 'monitoring' }
                        };
                    }
                    
                    resolve({
                        json: () => Promise.resolve(mockResponse)
                    });
                }, Math.random() * 500 + 200); // Simular latencia de red
            });
        };

        // Incluir todas las funciones del wizard aqu√≠...
        // (Las funciones ya est√°n implementadas en el archivo principal)
        
        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            logTest('INIT', 'P√°gina de prueba cargada correctamente');
        });
    </script>
    
    <!-- Incluir el JavaScript del wizard principal -->
    <script>
        // Aqu√≠ incluimos las funciones principales del wizard
        // Las funciones loadPieceSelectionStep, loadMaterialSelectionStep, etc. van aqu√≠
        
        // ===============================
        // FUNCIONES DE SELECCI√ìN DE PIEZAS
        // ===============================
        async function loadPieceSelectionStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="selectPieces()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            ‚úÖ Confirmar Selecci√≥n
                        </button>
                    `;
                }
            }, 100);
            
            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">üìÅ Selecci√≥n de Piezas</h3>
                        <p class="text-gray-600">Elige las piezas STL que deseas imprimir</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${mockProjectData.stl_files.map((file, index) => `
                            <div class="border rounded-lg p-4 hover:border-blue-300 transition-colors">
                                <label class="flex items-center space-x-3 cursor-pointer">
                                    <input type="checkbox" ${index < 8 ? 'checked' : ''} class="w-4 h-4 text-blue-600 rounded piece-checkbox" data-filename="${file}">
                                    <div class="flex-1">
                                        <div class="font-medium text-gray-900">${file}</div>
                                        <div class="text-sm text-gray-500">${Math.floor(Math.random() * 500) + 100} KB</div>
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <div class="text-center text-sm text-gray-600">
                        <span id="selected-count">8</span> de ${mockProjectData.stl_files.length} archivos seleccionados
                    </div>
                </div>
            `;
        }

        function selectPieces() {
            const selected = Array.from(document.querySelectorAll('.piece-checkbox:checked')).map(cb => cb.dataset.filename);
            logTest('SELECT', `Piezas seleccionadas: ${selected.length}`);
            loadPrintFlowStep(null, null, 'material_selection');
        }

        // ===============================
        // FUNCIONES DE SELECCI√ìN DE MATERIAL
        // ===============================
        async function loadMaterialSelectionStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="selectMaterial()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            ‚úÖ Confirmar Material
                        </button>
                    `;
                }
            }, 100);

            const mockMaterials = [
                { id: 1, tipo: 'PLA', color: 'Blanco', marca: 'eSUN', disponible: true, stock: 750 },
                { id: 2, tipo: 'PLA', color: 'Negro', marca: 'eSUN', disponible: true, stock: 420 },
                { id: 3, tipo: 'PETG', color: 'Transparente', marca: 'Prusament', disponible: false, stock: 0 }
            ];

            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">üé® Selecci√≥n de Material</h3>
                        <p class="text-gray-600">Elige el material para tu impresi√≥n</p>
                    </div>
                    <div class="space-y-3">
                        ${mockMaterials.map((material, index) => `
                            <div class="border rounded-lg p-4 ${!material.disponible ? 'bg-gray-50 opacity-60' : 'hover:border-blue-300 cursor-pointer'}" 
                                 ${material.disponible ? `onclick="selectMaterialOption(${material.id})"` : ''}>
                                <label class="flex items-center justify-between ${material.disponible ? 'cursor-pointer' : 'cursor-not-allowed'}">
                                    <div class="flex items-center space-x-3">
                                        <input type="radio" name="material" value="${material.id}" 
                                               ${index === 0 && material.disponible ? 'checked' : ''} 
                                               ${!material.disponible ? 'disabled' : ''} 
                                               class="w-4 h-4 text-blue-600">
                                        <div>
                                            <div class="font-medium text-gray-900">
                                                ${material.tipo} ${material.color} - ${material.marca}
                                            </div>
                                            <div class="text-sm text-gray-500">
                                                Stock: ${material.stock}g ${!material.disponible ? '(Agotado)' : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <span class="text-sm ${material.disponible ? 'text-green-600' : 'text-red-600'}">
                                            ${material.disponible ? '‚úÖ Disponible' : '‚ùå No disponible'}
                                        </span>
                                    </div>
                                </label>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function selectMaterialOption(materialId) {
            document.querySelector(`input[value="${materialId}"]`).checked = true;
        }

        function selectMaterial() {
            const selectedMaterial = document.querySelector('input[name="material"]:checked');
            logTest('SELECT', `Material seleccionado: ID ${selectedMaterial?.value}`);
            loadPrintFlowStep(null, null, 'production_mode');
        }

        // ===============================
        // FUNCIONES DE MODO DE PRODUCCI√ìN
        // ===============================
        async function loadProductionModeStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="selectProductionMode()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            ‚úÖ Aplicar Configuraci√≥n
                        </button>
                    `;
                }
            }, 100);

            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">‚öôÔ∏è Modo de Producci√≥n</h3>
                        <p class="text-gray-600">Selecciona el modo de impresi√≥n seg√∫n tus prioridades</p>
                    </div>
                    <div class="space-y-4">
                        <div class="border rounded-lg p-4 hover:border-blue-300 cursor-pointer bg-blue-50 border-blue-200" onclick="selectModeOption('prototype')">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="mode" value="prototype" checked class="w-4 h-4 text-blue-600">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">üöÄ Prototipo (Velocidad)</div>
                                    <div class="text-sm text-gray-600">Impresi√≥n r√°pida para pruebas - Altura: 0.3mm, Relleno: 15%</div>
                                    <div class="text-xs text-blue-600 mt-1">Tiempo estimado: ~4-6 horas</div>
                                </div>
                            </label>
                        </div>
                        <div class="border rounded-lg p-4 hover:border-blue-300 cursor-pointer" onclick="selectModeOption('production')">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="mode" value="production" class="w-4 h-4 text-blue-600">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">üè≠ Producci√≥n (Balance)</div>
                                    <div class="text-sm text-gray-600">Balance entre calidad y velocidad - Altura: 0.2mm, Relleno: 20%</div>
                                    <div class="text-xs text-gray-600 mt-1">Tiempo estimado: ~6-8 horas</div>
                                </div>
                            </label>
                        </div>
                        <div class="border rounded-lg p-4 hover:border-blue-300 cursor-pointer" onclick="selectModeOption('detailed')">
                            <label class="flex items-center space-x-3 cursor-pointer">
                                <input type="radio" name="mode" value="detailed" class="w-4 h-4 text-blue-600">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">üéØ Detallado (Calidad)</div>
                                    <div class="text-sm text-gray-600">M√°xima calidad de impresi√≥n - Altura: 0.15mm, Relleno: 25%</div>
                                    <div class="text-xs text-gray-600 mt-1">Tiempo estimado: ~8-12 horas</div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        function selectModeOption(mode) {
            document.querySelector(`input[value="${mode}"]`).checked = true;
        }

        function selectProductionMode() {
            const selectedMode = document.querySelector('input[name="mode"]:checked');
            logTest('SELECT', `Modo seleccionado: ${selectedMode?.value}`);
            loadPrintFlowStep(null, null, 'printer_assignment');
        }

        // ===============================
        // FUNCIONES DE ASIGNACI√ìN DE IMPRESORA
        // ===============================
        async function loadPrinterAssignmentStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="assignPrinter()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            ‚úÖ Asignar Impresora
                        </button>
                    `;
                }
            }, 100);

            const mockPrinters = [
                { id: 1, nombre: 'Impresora Prueba', estado: 'disponible', tipo: 'FDM', ubicacion: 'Lab A' },
                { id: 2, nombre: 'Ender 3 Pro', estado: 'ocupada', tipo: 'FDM', ubicacion: 'Lab B' },
                { id: 3, nombre: 'Prusa i3', estado: 'mantenimiento', tipo: 'FDM', ubicacion: 'Lab A' }
            ];

            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">üñ®Ô∏è Asignaci√≥n de Impresora</h3>
                        <p class="text-gray-600">Selecciona la impresora para tu trabajo</p>
                    </div>
                    <div class="space-y-3">
                        ${mockPrinters.map((printer, index) => {
                            const isAvailable = printer.estado === 'disponible';
                            const statusColor = isAvailable ? 'text-green-600' : 
                                               printer.estado === 'ocupada' ? 'text-yellow-600' : 'text-red-600';
                            const statusIcon = isAvailable ? '‚úÖ' : 
                                              printer.estado === 'ocupada' ? '‚è≥' : 'üîß';
                            
                            return `
                                <div class="border rounded-lg p-4 ${!isAvailable ? 'bg-gray-50 opacity-60' : 'hover:border-blue-300 cursor-pointer'}" 
                                     ${isAvailable ? `onclick="selectPrinterOption(${printer.id})"` : ''}>
                                    <label class="flex items-center justify-between ${isAvailable ? 'cursor-pointer' : 'cursor-not-allowed'}">
                                        <div class="flex items-center space-x-3">
                                            <input type="radio" name="printer" value="${printer.id}" 
                                                   ${index === 0 && isAvailable ? 'checked' : ''} 
                                                   ${!isAvailable ? 'disabled' : ''} 
                                                   class="w-4 h-4 text-blue-600">
                                            <div>
                                                <div class="font-medium text-gray-900">
                                                    ${printer.nombre}
                                                </div>
                                                <div class="text-sm text-gray-500">
                                                    ${printer.tipo} ‚Ä¢ ${printer.ubicacion}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm ${statusColor}">
                                                ${statusIcon} ${printer.estado.charAt(0).toUpperCase() + printer.estado.slice(1)}
                                            </span>
                                        </div>
                                    </label>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function selectPrinterOption(printerId) {
            document.querySelector(`input[value="${printerId}"]`).checked = true;
        }

        function assignPrinter() {
            const selectedPrinter = document.querySelector('input[name="printer"]:checked');
            logTest('SELECT', `Impresora asignada: ID ${selectedPrinter?.value}`);
            loadPrintFlowStep(null, null, 'stl_processing');
        }

        // ===============================
        // FUNCIONES PARA PROCESAMIENTO STL
        // ===============================
        async function loadSTLProcessingStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="startSTLProcessing()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            üîÑ Procesar Archivos
                        </button>
                    `;
                }
            }, 100);
            
            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">üîÑ Procesamiento STL</h3>
                        <p class="text-gray-600">Generando G-code para los archivos seleccionados</p>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-3">Estado del Procesamiento:</h4>
                        <div id="processing-status" class="space-y-2">
                            <div class="text-sm text-blue-700">
                                ‚è≥ Listo para procesar archivos STL con APISLICER
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-3">Configuraci√≥n de Laminado:</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-700">
                            <div><strong>Material:</strong> PLA Blanco</div>
                            <div><strong>Temperatura extrusor:</strong> 210¬∞C</div>
                            <div><strong>Temperatura cama:</strong> 60¬∞C</div>
                            <div><strong>Altura de capa:</strong> 0.3mm</div>
                            <div><strong>Relleno:</strong> 15%</div>
                            <div><strong>Velocidad:</strong> 80mm/s</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function startSTLProcessing() {
            try {
                showToast('Procesando', 'Iniciando procesamiento de archivos STL...', 'info');
                updateProcessingStatus('Procesando archivos...', 'in-progress');
                
                // Simular procesamiento
                setTimeout(() => {
                    updateProcessingStatus('Procesamiento completado', 'success');
                    showToast('Procesamiento Completado', '8 archivos procesados', 'success');
                    
                    setTimeout(() => {
                        loadPrintFlowStep(null, null, 'validation');
                    }, 1500);
                }, 2000);
                
            } catch (error) {
                updateProcessingStatus('Error de conexi√≥n', 'error');
                showToast('Error', 'Error de conexi√≥n con el servidor', 'error');
            }
        }

        function updateProcessingStatus(message, status) {
            const statusContainer = document.getElementById('processing-status');
            if (!statusContainer) return;
            
            const statusIcon = status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚è≥';
            const statusClass = status === 'success' ? 'text-green-700' : status === 'error' ? 'text-red-700' : 'text-blue-700';
            
            statusContainer.innerHTML = `
                <div class="text-sm ${statusClass}">
                    ${statusIcon} ${message}
                </div>
            `;
        }

        // ===============================
        // FUNCIONES PARA VALIDACI√ìN
        // ===============================
        async function loadValidationStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="proceedToConfirmation()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            ‚úÖ Validaci√≥n OK - Continuar
                        </button>
                    `;
                }
            }, 100);
            
            const mockValidation = {
                processing_summary: {
                    successful: 8,
                    total_files: 8,
                    total_estimated_time_hours: 6.5,
                    total_filament_grams: 110.7,
                    estimated_cost: 2.77
                },
                validation_checks: {
                    material_availability: { status: 'success', details: 'Material PLA disponible (750g)' },
                    printer_status: { status: 'success', details: 'Impresora lista y calibrada' },
                    file_integrity: { status: 'success', details: 'Todos los archivos G-code v√°lidos' },
                    bed_size: { status: 'warning', details: 'Algunas piezas grandes - revisar orientaci√≥n' }
                },
                warnings: ['Pieza "handle.stl" podr√≠a beneficiarse de soportes'],
                errors: [],
                recommendations: ['Considerar agrupar piezas peque√±as', 'Revisar temperatura de primera capa']
            };
            
            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">‚úÖ Validaci√≥n Final</h3>
                        <p class="text-gray-600">Revisi√≥n del plan de impresi√≥n antes de ejecutar</p>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-3">üìã Resumen del Trabajo</h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-blue-800">
                            <div class="text-center">
                                <div class="text-lg font-bold">${mockValidation.processing_summary.successful}/${mockValidation.processing_summary.total_files}</div>
                                <div>Archivos listos</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold">${mockValidation.processing_summary.total_estimated_time_hours}h</div>
                                <div>Tiempo estimado</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold">${mockValidation.processing_summary.total_filament_grams}g</div>
                                <div>Filamento</div>
                            </div>
                            <div class="text-center">
                                <div class="text-lg font-bold">‚Ç¨${mockValidation.processing_summary.estimated_cost}</div>
                                <div>Costo estimado</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        <h4 class="font-medium text-gray-900">Verificaciones:</h4>
                        ${Object.entries(mockValidation.validation_checks).map(([key, check]) => `
                            <div class="flex items-center justify-between p-3 border rounded-lg ${
                                check.status === 'success' ? 'border-green-200 bg-green-50' : 
                                check.status === 'warning' ? 'border-yellow-200 bg-yellow-50' : 'border-red-200 bg-red-50'
                            }">
                                <div class="flex items-center space-x-3">
                                    <div class="text-lg">
                                        ${check.status === 'success' ? '‚úÖ' : check.status === 'warning' ? '‚ö†Ô∏è' : '‚ùå'}
                                    </div>
                                    <div>
                                        <div class="font-medium ${
                                            check.status === 'success' ? 'text-green-800' : 
                                            check.status === 'warning' ? 'text-yellow-800' : 'text-red-800'
                                        }">
                                            ${key.replace(/_/g, ' ').toUpperCase()}
                                        </div>
                                        <div class="text-sm ${
                                            check.status === 'success' ? 'text-green-600' : 
                                            check.status === 'warning' ? 'text-yellow-600' : 'text-red-600'
                                        }">
                                            ${check.details}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${mockValidation.warnings.length > 0 ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-medium text-yellow-800 mb-2">‚ö†Ô∏è Advertencias</h4>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                ${mockValidation.warnings.map(warning => `<li>‚Ä¢ ${warning}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${mockValidation.recommendations.length > 0 ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-medium text-blue-800 mb-2">üí° Recomendaciones</h4>
                            <ul class="text-sm text-blue-700 space-y-1">
                                ${mockValidation.recommendations.map(rec => `<li>‚Ä¢ ${rec}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function proceedToConfirmation() {
            logTest('VALIDATE', 'Validaci√≥n completada, procediendo a confirmaci√≥n');
            loadPrintFlowStep(null, null, 'confirmation');
        }

        // ===============================
        // FUNCIONES PARA CONFIRMACI√ìN
        // ===============================
        async function loadConfirmationStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="confirmPrintJob()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            üöÄ Confirmar e Iniciar Impresi√≥n
                        </button>
                    `;
                }
            }, 100);
            
            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">üë§ Confirmaci√≥n Final</h3>
                        <p class="text-gray-600">√öltima revisi√≥n antes de enviar a impresi√≥n</p>
                    </div>
                    
                    <div class="bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg p-6">
                        <h4 class="font-bold text-gray-900 mb-4 text-center">üìã Resumen de Impresi√≥n</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div class="space-y-2">
                                <div><strong>Proyecto:</strong> ATX Power Supply</div>
                                <div><strong>Piezas:</strong> 8 de 9 archivos</div>
                                <div><strong>Material:</strong> PLA Blanco (eSUN)</div>
                                <div><strong>Impresora:</strong> Impresora Prueba</div>
                            </div>
                            <div class="space-y-2">
                                <div><strong>Tiempo estimado:</strong> 6.5 horas</div>
                                <div><strong>Filamento:</strong> 110.7g</div>
                                <div><strong>Costo:</strong> ‚Ç¨2.77</div>
                                <div><strong>Modo:</strong> Prototipo (Velocidad)</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">Notas adicionales (opcional):</label>
                        <textarea id="user-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Cualquier observaci√≥n o instrucci√≥n especial..."></textarea>
                    </div>
                    
                    <div class="space-y-3">
                        <h4 class="font-medium text-gray-900">Confirmaciones requeridas:</h4>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="confirm-materials" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm text-gray-700">Confirmo que el material est√° disponible y cargado</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="confirm-printer" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm text-gray-700">He verificado que la impresora est√° ready y calibrada</span>
                        </label>
                        <label class="flex items-center space-x-3">
                            <input type="checkbox" id="confirm-settings" class="w-4 h-4 text-blue-600 rounded">
                            <span class="text-sm text-gray-700">Los par√°metros de impresi√≥n son correctos</span>
                        </label>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="text-center">
                            <div class="text-sm text-gray-600 mb-2">Si confirmas ahora:</div>
                            <div class="text-lg font-bold text-blue-600">Inicio estimado: Inmediato</div>
                            <div class="text-sm text-gray-600">Finalizaci√≥n estimada: Hoy 18:30</div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function confirmPrintJob() {
            const confirmMaterials = document.getElementById('confirm-materials')?.checked;
            const confirmPrinter = document.getElementById('confirm-printer')?.checked;
            const confirmSettings = document.getElementById('confirm-settings')?.checked;
            
            if (!confirmMaterials || !confirmPrinter || !confirmSettings) {
                showToast('Atenci√≥n', 'Debes confirmar todos los elementos antes de continuar', 'warning');
                return;
            }
            
            try {
                showToast('Confirmando', 'Enviando trabajo a impresora...', 'info');
                logTest('CONFIRM', 'Confirmando trabajo de impresi√≥n');
                
                setTimeout(() => {
                    showToast('¬°Trabajo Confirmado!', 'Impresi√≥n iniciada exitosamente', 'success');
                    loadPrintFlowStep(null, null, 'monitoring');
                }, 1500);
                
            } catch (error) {
                showToast('Error', 'Error de conexi√≥n', 'error');
            }
        }

        // ===============================
        // FUNCIONES PARA MONITOREO
        // ===============================
        async function loadMonitoringStep() {
            setTimeout(() => {
                const actionsContainer = document.getElementById('wizard-actions');
                if (actionsContainer) {
                    actionsContainer.innerHTML = `
                        <button onclick="refreshJobStatus()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            üîÑ Actualizar Estado
                        </button>
                        <button onclick="closePrintFlowWizard()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                            ‚úÖ Cerrar Asistente
                        </button>
                    `;
                }
            }, 100);
            
            return `
                <div class="space-y-6">
                    <div class="text-center">
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">üëÅÔ∏è Monitoreo de Impresi√≥n</h3>
                        <p class="text-gray-600">Seguimiento en tiempo real del trabajo</p>
                    </div>
                    
                    <div id="job-status-container" class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-bold text-green-800">üñ®Ô∏è Trabajo Confirmado</h4>
                                <p class="text-sm text-green-700">El trabajo se ha enviado a la impresora exitosamente</p>
                            </div>
                            <div class="text-green-600 text-2xl">‚úÖ</div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-4">
                        <h4 class="font-medium text-blue-900 mb-3">üìä Informaci√≥n del Trabajo</h4>
                        <div class="grid grid-cols-2 gap-4 text-sm text-blue-800">
                            <div><strong>Job ID:</strong> <span class="font-mono text-xs">abc123-def456</span></div>
                            <div><strong>Cola de posici√≥n:</strong> #1</div>
                            <div><strong>Inicio estimado:</strong> Inmediato</div>
                            <div><strong>Estado:</strong> Encolado</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-3">üîÑ Pr√≥ximos Pasos</h4>
                        <ul class="text-sm text-gray-700 space-y-2">
                            <li>‚Ä¢ El trabajo se agreg√≥ a la cola de impresi√≥n</li>
                            <li>‚Ä¢ Puedes monitorear el progreso en tiempo real</li>
                            <li>‚Ä¢ Recibir√°s notificaciones de estado importantes</li>
                            <li>‚Ä¢ El asistente se puede cerrar - el monitoreo contin√∫a</li>
                        </ul>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-sm text-gray-600">
                            ¬°El flujo de impresi√≥n se complet√≥ exitosamente! üéâ<br>
                            Tu trabajo est√° ahora en la cola de impresi√≥n.
                        </p>
                    </div>
                </div>
            `;
        }

        function refreshJobStatus() {
            showToast('Actualizando', 'Obteniendo estado actual del trabajo...', 'info');
            logTest('REFRESH', 'Actualizando estado del trabajo');
            setTimeout(() => {
                showToast('Estado Actualizado', 'Trabajo en cola, posici√≥n #1', 'success');
            }, 1000);
        }

        // Actualizar contador de piezas seleccionadas
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('piece-checkbox')) {
                const selectedCount = document.querySelectorAll('.piece-checkbox:checked').length;
                const counter = document.getElementById('selected-count');
                if (counter) counter.textContent = selectedCount;
            }
        });
    </script>
</body>
</html>