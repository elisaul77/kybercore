# Sistema de Impresi√≥n Aut√≥nomo - KyberCore

## üìã Visi√≥n General

El sistema de impresi√≥n aut√≥nomo de KyberCore permite a los usuarios enviar trabajos de impresi√≥n de manera inteligente y completamente automatizada. La funcionalidad est√° dise√±ada para adaptarse tanto a necesidades de prototipado individual como a producci√≥n en serie, optimizando el uso de la flota de impresoras disponibles.

## üéØ Objetivos Principales

- **Autonom√≠a completa**: Proceso de impresi√≥n sin intervenci√≥n manual
- **Flexibilidad de selecci√≥n**: Elegir piezas espec√≠ficas o proyecto completo
- **Gesti√≥n inteligente de impresoras**: Distribuci√≥n autom√°tica o manual
- **Modos de producci√≥n**: Prototipado vs. Fabricaci√≥n en serie
- **Optimizaci√≥n de bandejas**: Aprovechamiento m√°ximo del espacio de impresi√≥n
- **Integraci√≥n con procesamiento**: Uso del contenedor STL ‚Üí G-code existente

## üîß Caracter√≠sticas Implementadas

### 1. **Selecci√≥n de Piezas**
- ‚úÖ **Todas las piezas**: Imprimir proyecto completo
- ‚úÖ **Piezas espec√≠ficas**: Selecci√≥n manual individual
- ‚úÖ **Vista previa**: Visualizaci√≥n de piezas seleccionadas
- ‚úÖ **Informaci√≥n detallada**: Tiempo estimado, material requerido

### 2. **Gesti√≥n de Impresoras**
- ‚úÖ **Selecci√≥n autom√°tica**: IA asigna impresoras √≥ptimas
- ‚úÖ **Selecci√≥n manual**: Usuario elige impresoras espec√≠ficas
- ‚úÖ **Estado en tiempo real**: Verificaci√≥n de disponibilidad
- ‚úÖ **Capacidades por impresora**: Materiales, volumen, caracter√≠sticas

### 3. **Modos de Producci√≥n**

#### üî¨ **Modo Prototipo**
- Una pieza por bandeja de impresi√≥n
- Prioridad en velocidad de entrega
- Optimizaci√≥n para iteraci√≥n r√°pida
- Menor densidad de impresi√≥n

#### üè≠ **Modo F√°brica**
- M√∫ltiples copias de la misma pieza por bandeja
- Optimizaci√≥n de material y tiempo
- Maximizaci√≥n del throughput
- Distribuci√≥n inteligente en la flota

### 4. **Procesamiento Inteligente**
- ‚úÖ **Gesti√≥n de materiales**: Cat√°logo completo con propiedades
- ‚úÖ **Validaci√≥n de stock**: Verificaci√≥n en tiempo real de disponibilidad
- ‚úÖ **Perfiles adaptativos**: Ajuste autom√°tico seg√∫n pieza + material + impresora
- ‚úÖ **Conversi√≥n STL ‚Üí G-code**: Integraci√≥n con contenedor existente
- ‚úÖ **Optimizaci√≥n de par√°metros**: Seg√∫n modo y material
- ‚úÖ **Validaci√≥n previa**: Verificaci√≥n de viabilidad
- ‚úÖ **Estimaciones precisas**: Tiempo, material, costos

### 5. **Sistema de Materiales y Stock**
- ‚úÖ **Cat√°logo de materiales**: PLA, ABS, PETG, TPU, etc.
- ‚úÖ **Propiedades por material**: Temperatura, velocidad, retracci√≥n
- ‚úÖ **Inventario en tiempo real**: Stock disponible por material/color
- ‚úÖ **Alertas de stock bajo**: Notificaciones autom√°ticas
- ‚úÖ **Sugerencias inteligentes**: Materiales alternativos compatibles
- ‚úÖ **C√°lculo de consumo**: Estimaci√≥n precisa por trabajo

## üîÑ Flujo de Trabajo

```mermaid
flowchart TD
    A[üë§ Usuario selecciona 'Imprimir'] --> B{üì¶ ¬øQu√© imprimir?}
    
    B -->|Todas las piezas| C[üìã Cargar lista completa]
    B -->|Piezas espec√≠ficas| D[üéØ Selector de piezas]
    
    C --> E[‚öôÔ∏è Configuraci√≥n de impresi√≥n]
    D --> E
    
    E --> F{üè≠ Modo de producci√≥n}
    F -->|Prototipo| G[üî¨ Config. prototipado]
    F -->|F√°brica| H[üè≠ Config. producci√≥n]
    
    G --> I[üß™ Selecci√≥n de material]
    H --> I
    
    I --> J[üì¶ Validaci√≥n de stock]
    J -->|Stock suficiente| K{üñ®Ô∏è Selecci√≥n impresoras}
    J -->|Stock insuficiente| L[‚ùå Alerta de stock]
    L --> M[üõí Sugerir compra/material alternativo]
    M --> I
    
    K -->|Autom√°tica| N[ü§ñ IA asigna impresoras]
    K -->|Manual| O[üë§ Usuario selecciona]
    
    N --> P[üìä An√°lisis de capacidad]
    O --> P
    
    P --> Q[üéØ Ajuste de perfil de impresi√≥n]
    Q --> R[‚öôÔ∏è Optimizaci√≥n pieza + material + impresora]
    R --> S[üîÑ Procesamiento STL ‚Üí G-code]
    S --> T[üìã Plan de impresi√≥n]
    T --> U{‚úÖ Confirmaci√≥n usuario}
    
    U -->|S√≠| V[üöÄ Env√≠o a impresoras]
    U -->|No| E
    
    V --> W[üìà Monitoreo en tiempo real]
    W --> X[‚úÖ Finalizaci√≥n]
    
    style A fill:#e1f5fe
    style I fill:#fff8e1
    style J fill:#ffecb3
    style Q fill:#f3e5f5
    style R fill:#e8f5e8
    style N fill:#f3e5f5
    style S fill:#fff3e0
    style V fill:#e8f5e8
```

## üèóÔ∏è Arquitectura T√©cnica

### **Componentes Principales**

```mermaid
graph TB
    subgraph "Frontend"
        UI[üñ•Ô∏è Interfaz Usuario]
        PC[üéõÔ∏è Panel Control]
        PM[üìä Monitor Progreso]
    end
    
    subgraph "Backend Core"
        API[üîå API Gateway]
        JM[üìã Job Manager]
        PE[‚öôÔ∏è Print Engine]
    end
    
    subgraph "Servicios IA"
        IA[ü§ñ Asignador IA]
        OP[üîç Optimizador]
        ES[üìä Estimador]
        PA[üéØ Profile Adapter]
    end
    
    subgraph "Gesti√≥n Materiales"
        MS[üß™ Material Service]
        SM[üì¶ Stock Manager]
        MC[üìã Material Catalog]
    end
    
    subgraph "Procesamiento"
        SC[üîÑ STL ‚Üí G-code Container]
        VP[‚úÖ Validador]
        GG[‚öôÔ∏è G-code Generator]
        PP[‚öôÔ∏è Profile Processor]
    end
    
    subgraph "Gesti√≥n Flota"
        FM[üñ®Ô∏è Fleet Manager]
        PS[üì° Printer Status]
        CC[üîó Communication Controller]
    end
    
    UI --> API
    PC --> API
    PM --> API
    
    API --> JM
    JM --> PE
    PE --> IA
    PE --> OP
    PE --> ES
    PE --> PA
    
    PE --> MS
    MS --> SM
    MS --> MC
    
    PE --> SC
    SC --> VP
    SC --> GG
    SC --> PP
    
    PE --> FM
    FM --> PS
    FM --> CC
    
    CC -.->|Moonraker API| PR1[üñ®Ô∏è Impresora 1]
    CC -.->|Moonraker API| PR2[üñ®Ô∏è Impresora 2]
    CC -.->|Moonraker API| PR3[üñ®Ô∏è Impresora N]
```

## üé® Dise√±o de Interfaz

### **Modal de Configuraci√≥n de Impresi√≥n**

```mermaid
graph TD
    subgraph "Paso 1: Selecci√≥n de Piezas"
        A1[üì¶ Lista de piezas disponibles]
        A2[‚òëÔ∏è Checkboxes para selecci√≥n]
        A3[üëÅÔ∏è Vista previa 3D]
        A4[üìä Resumen: X piezas, Y material estimado]
    end
    
    subgraph "Paso 2: Selecci√≥n de Material"
        B1[üß™ Cat√°logo de materiales]
        B2[üé® Selector de color]
        B3[üì¶ Verificaci√≥n de stock]
        B4[‚ö†Ô∏è Alertas de stock bajo]
        B5[üí° Sugerencias alternativas]
    end
    
    subgraph "Paso 3: Modo de Producci√≥n"
        C1[üî¨ Modo Prototipo]
        C2[üè≠ Modo F√°brica]
        C3[‚öôÔ∏è Configuraciones avanzadas]
    end
    
    subgraph "Paso 4: Selecci√≥n de Impresoras"
        D1[ü§ñ Asignaci√≥n autom√°tica IA]
        D2[üë§ Selecci√≥n manual]
        D3[üìä Estado y capacidades]
        D4[‚úÖ Compatibilidad con material]
    end
    
    subgraph "Paso 5: Ajuste de Perfil"
        E1[üéØ Perfil base por material]
        E2[üîß Ajustes autom√°ticos por pieza]
        E3[‚öôÔ∏è Optimizaci√≥n por impresora]
        E4[üëÅÔ∏è Vista previa de configuraci√≥n]
    end
    
    subgraph "Paso 6: Confirmaci√≥n"
        F1[üìã Plan de impresi√≥n completo]
        F2[‚è±Ô∏è Tiempo estimado total]
        F3[üí∞ Costo de material]
        F4[üìä Distribuci√≥n por impresora]
        F5[üöÄ Bot√≥n confirmar]
    end
```

## üìä Algoritmos de Optimizaci√≥n

### **Sistema de Perfiles Adaptativos**

El sistema de perfiles adaptativos es el coraz√≥n de la inteligencia de impresi√≥n, combinando an√°lisis geom√©trico, propiedades de materiales y caracter√≠sticas espec√≠ficas de cada impresora.

```mermaid
flowchart TD
    subgraph "An√°lisis de Entrada"
        A1[üìê Geometr√≠a STL]
        A2[üß™ Propiedades Material]
        A3[üñ®Ô∏è Caracter√≠sticas Impresora]
    end
    
    subgraph "Procesamiento IA"
        B1[üîç An√°lisis Geom√©trico]
        B2[‚öôÔ∏è C√°lculo de Par√°metros]
        B3[üéØ Optimizaci√≥n Multi-Variable]
    end
    
    subgraph "Generaci√≥n de Perfil"
        C1[üå°Ô∏è Temperaturas Optimizadas]
        C2[‚ö° Velocidades Adaptadas]
        C3[üîÑ Retracciones Espec√≠ficas]
        C4[üìè Alturas de Capa Variables]
        C5[üõ°Ô∏è Soportes Inteligentes]
    end
    
    A1 --> B1
    A2 --> B2
    A3 --> B3
    
    B1 --> C1
    B1 --> C4
    B1 --> C5
    B2 --> C1
    B2 --> C2
    B2 --> C3
    B3 --> C2
    B3 --> C4
    
    C1 --> D[‚öôÔ∏è Perfil Final Optimizado]
    C2 --> D
    C3 --> D
    C4 --> D
    C5 --> D
```

#### **Factores de Optimizaci√≥n por Pieza:**
- **Overhangs y puentes**: Ajuste de velocidades y cooling
- **Detalles finos**: Optimizaci√≥n de altura de capa y flujo
- **Paredes delgadas**: Configuraci√≥n espec√≠fica de per√≠metros
- **Superficies cr√≠ticas**: Calidad vs velocidad adaptativa

#### **Adaptaci√≥n por Material:**
- **PLA**: Temperaturas conservadoras, alta velocidad
- **ABS**: Control de warping, cama caliente optimizada
- **PETG**: Balance qu√≠mico-resistencia, retracci√≥n m√≠nima
- **TPU**: Velocidades reducidas, presi√≥n espec√≠fica

#### **Calibraci√≥n por Impresora:**
- **Offset espec√≠fico**: Compensaci√≥n por desgaste/calibraci√≥n
- **Aceleraci√≥n m√°xima**: L√≠mites f√≠sicos de cada m√°quina
- **Cooling efficiency**: Capacidad de enfriamiento espec√≠fica
- **Extrusor characteristics**: Flow rate y temperatura real

### **Asignaci√≥n Inteligente de Impresoras**

1. **An√°lisis de Capacidades**
   - Volumen de impresi√≥n disponible
   - Materiales compatibles instalados
   - Estado actual (disponible/ocupada)
   - Historial de rendimiento por material

2. **Validaci√≥n de Materiales**
   - Verificaci√≥n de material cargado en cada impresora
   - Compatibilidad temperatura de extrusor/cama
   - Disponibilidad de stock suficiente
   - Validaci√≥n de configuraciones espec√≠ficas

3. **Optimizaci√≥n de Perfiles**
   - **An√°lisis geom√©trico de pieza**: Overhangs, puentes, detalles finos
   - **Adaptaci√≥n por material**: Temperaturas, velocidades, retracciones
   - **Optimizaci√≥n por impresora**: Calibraci√≥n espec√≠fica, offsets
   - **Modo de producci√≥n**: Calidad vs velocidad vs econom√≠a

4. **Optimizaci√≥n Multi-objetivo**
   - Minimizar tiempo total de producci√≥n
   - Maximizar utilizaci√≥n de flota
   - Balancear carga de trabajo
   - Priorizar seg√∫n urgencia y material disponible

5. **Distribuci√≥n en Modo F√°brica**
   - C√°lculo de piezas por bandeja seg√∫n material
   - Optimizaci√≥n espacial 2D/3D considerando shrinkage
   - Consideraci√≥n de tiempo de setup y cambio material
   - Minimizaci√≥n de desperdicio y warping

## üîÑ Estados del Sistema

```mermaid
stateDiagram-v2
    [*] --> Idle
    Idle --> Configuring : Usuario inicia impresi√≥n
    Configuring --> MaterialSelection : Configuraci√≥n b√°sica completa
    MaterialSelection --> StockValidation : Material seleccionado
    StockValidation --> PrinterAssignment : Stock confirmado
    StockValidation --> StockAlert : Stock insuficiente
    StockAlert --> MaterialSelection : Cambiar material
    StockAlert --> PurchaseOrder : Solicitar compra
    PurchaseOrder --> MaterialSelection : Material disponible
    PrinterAssignment --> ProfileOptimization : Impresoras asignadas
    ProfileOptimization --> Processing : Perfil optimizado
    Processing --> Queued : STL ‚Üí G-code listo
    Queued --> Printing : Impresora disponible
    Printing --> Monitoring : Impresi√≥n iniciada
    Monitoring --> Completed : Impresi√≥n exitosa
    Monitoring --> Failed : Error detectado
    Failed --> Retry : Reintentar
    Failed --> Cancelled : Usuario cancela
    Retry --> ProfileOptimization : Re-optimizar perfil
    Completed --> [*]
    Cancelled --> [*]
    
    Configuring --> Idle : Usuario cancela
    MaterialSelection --> Idle : Usuario cancela
    Processing --> Idle : Error cr√≠tico
    Queued --> Idle : Usuario cancela
```

## üìÅ Estructura de Archivos

```
src/
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îú‚îÄ‚îÄ print_controller.py          # Controlador principal de impresi√≥n
‚îÇ   ‚îú‚îÄ‚îÄ material_controller.py       # Gesti√≥n de materiales y stock
‚îÇ   ‚îî‚îÄ‚îÄ job_controller.py            # Gesti√≥n de trabajos
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ print_service.py             # L√≥gica de negocio de impresi√≥n
‚îÇ   ‚îú‚îÄ‚îÄ material_service.py          # Gesti√≥n de materiales
‚îÇ   ‚îú‚îÄ‚îÄ stock_service.py             # Validaci√≥n y gesti√≥n de inventario
‚îÇ   ‚îú‚îÄ‚îÄ profile_service.py           # Ajuste de perfiles de impresi√≥n
‚îÇ   ‚îú‚îÄ‚îÄ printer_assignment_service.py # Asignaci√≥n inteligente
‚îÇ   ‚îú‚îÄ‚îÄ gcode_processor_service.py   # Integraci√≥n con contenedor
‚îÇ   ‚îî‚îÄ‚îÄ optimization_service.py      # Algoritmos de optimizaci√≥n
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ print_job.py                 # Modelo de trabajo de impresi√≥n
‚îÇ   ‚îú‚îÄ‚îÄ print_config.py              # Configuraci√≥n de impresi√≥n
‚îÇ   ‚îú‚îÄ‚îÄ material.py                  # Modelo de material
‚îÇ   ‚îú‚îÄ‚îÄ stock_item.py                # Inventario de materiales
‚îÇ   ‚îú‚îÄ‚îÄ print_profile.py             # Perfiles de impresi√≥n
‚îÇ   ‚îî‚îÄ‚îÄ print_queue.py               # Cola de impresi√≥n
‚îú‚îÄ‚îÄ web/
‚îÇ   ‚îú‚îÄ‚îÄ templates/modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ print_modal.html         # Modal de configuraci√≥n
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ material_selector.html   # Selector de materiales
‚îÇ   ‚îî‚îÄ‚îÄ static/js/modules/
‚îÇ       ‚îú‚îÄ‚îÄ print_manager.js         # Frontend de impresi√≥n
‚îÇ       ‚îî‚îÄ‚îÄ material_manager.js      # Gesti√≥n de materiales
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ stl_analyzer.py              # An√°lisis de archivos STL
    ‚îú‚îÄ‚îÄ material_calculator.py       # C√°lculos de consumo
    ‚îú‚îÄ‚îÄ profile_optimizer.py         # Optimizaci√≥n de perfiles
    ‚îî‚îÄ‚îÄ print_estimator.py           # Estimaciones de tiempo/costo
```

## üöÄ Plan de Implementaci√≥n

### **Fase 1: Infraestructura Base** (Semana 1-2)
- [ ] Crear modelos de datos (PrintJob, PrintConfig, Material, StockItem)
- [ ] Implementar controlador base de impresi√≥n y materiales
- [ ] Sistema b√°sico de gesti√≥n de stock
- [ ] Integrar con contenedor STL ‚Üí G-code existente
- [ ] Crear interfaz b√°sica de selecci√≥n

### **Fase 2: Sistema de Materiales y Perfiles** (Semana 3-4)
- [ ] Cat√°logo completo de materiales con propiedades
- [ ] Sistema de validaci√≥n de stock en tiempo real
- [ ] Motor de ajuste de perfiles adaptativos
- [ ] Algoritmos de optimizaci√≥n pieza + material + impresora
- [ ] Interfaz de selecci√≥n de materiales

### **Fase 3: L√≥gica de Negocio Avanzada** (Semana 5-6)
- [ ] Desarrollar service de asignaci√≥n inteligente de impresoras
- [ ] Implementar modos Prototipo vs F√°brica con materiales
- [ ] Sistema de alertas y sugerencias de stock
- [ ] Estimaciones precisas de consumo y costos

### **Fase 4: Interfaz Completa y IA** (Semana 7-8)
- [ ] Modal completo de configuraci√≥n en 6 pasos
- [ ] Vista previa 3D de piezas con material
- [ ] Panel de monitoreo en tiempo real
- [ ] Algoritmos de ML para optimizaci√≥n de perfiles
- [ ] Sistema de recomendaciones inteligentes

## üîó Integraci√≥n con Sistemas Existentes

### **Contenedor STL ‚Üí G-code**
- **Entrada**: Archivos STL + configuraciones
- **Proceso**: Slicing autom√°tico con par√°metros optimizados
- **Salida**: G-code listo para impresi√≥n
- **Integraci√≥n**: API REST para procesamiento en lote

### **Fleet Manager**
- **Comunicaci√≥n**: API Moonraker para cada impresora
- **Monitoreo**: Estado, progreso, temperatura
- **Control**: Inicio, pausa, cancelaci√≥n de trabajos
- **Sincronizaci√≥n**: Actualizaci√≥n en tiempo real

### **Base de Datos**
- **Historial**: Trabajos completados y estad√≠sticas
- **Configuraciones**: Perfiles de impresi√≥n guardados
- **Usuarios**: Preferencias y configuraciones personales
- **Analytics**: M√©tricas de rendimiento y utilizaci√≥n

---

## üìù Notas de Implementaci√≥n

> **Prioridad Alta**: Integraci√≥n con contenedor existente y funcionalidad b√°sica
> 
> **Consideraciones**: Mantener compatibilidad con arquitectura modular actual
> 
> **Testing**: Implementar pruebas unitarias para cada componente cr√≠tico
> 
> **Documentaci√≥n**: Mantener documentaci√≥n actualizada durante desarrollo
