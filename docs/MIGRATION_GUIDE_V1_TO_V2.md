# Gu√≠a de Migraci√≥n: V1 ‚Üí V2 (Arquitectura Backend-Centric)

## üìã Tabla de Contenidos
1. [Resumen de Cambios](#resumen-de-cambios)
2. [Preparaci√≥n](#preparaci√≥n)
3. [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
4. [Activaci√≥n de V2](#activaci√≥n-de-v2)
5. [Verificaci√≥n](#verificaci√≥n)
6. [Rollback a V1](#rollback-a-v1)
7. [Monitoreo y Troubleshooting](#monitoreo-y-troubleshooting)
8. [FAQ](#faq)

---

## Resumen de Cambios

### ¬øQu√© cambi√≥?

**V1 (Frontend-Heavy - LEGACY)**:
- El navegador descarga cada archivo STL
- El navegador env√≠a cada STL a APISLICER para rotaci√≥n
- El navegador guarda cada archivo rotado en el servidor
- El navegador solicita el slicing de cada archivo
- **~30 HTTP requests** para 10 archivos (3 por archivo)
- **Procesamiento secuencial** (uno por uno)
- **Sin retry autom√°tico** si algo falla
- **~20 segundos** para 10 archivos

**V2 (Backend-Centric - RECOMENDADO) ‚ú®**:
- El navegador env√≠a **1 solicitud** con la lista de archivos
- El backend orquesta todo el procesamiento
- **Procesamiento paralelo** (3 archivos simult√°neos)
- **Retry autom√°tico** (3 intentos por archivo)
- El navegador solo hace **polling cada 2 segundos** para ver el progreso
- **~6 segundos** para 10 archivos
- **Mejor manejo de errores** y transaccionalidad

### Beneficios de V2

| Aspecto | V1 | V2 | Mejora |
|---------|----|----|--------|
| Requests HTTP | ~30 | 1 + polling | 95% menos tr√°fico |
| Tiempo (10 archivos) | ~20s | ~6s | 70% m√°s r√°pido |
| Paralelizaci√≥n | No | S√≠ (3 archivos) | 3x throughput |
| Retry autom√°tico | No | S√≠ (3 intentos) | Mayor confiabilidad |
| Separaci√≥n de concerns | ‚ùå | ‚úÖ | Mejor arquitectura |
| Escalabilidad | Baja | Alta | Preparado para m√°s load |
| Experiencia de usuario | B√°sica | Avanzada | Progress bar, % |

---

## Preparaci√≥n

### Requisitos Previos

1. **Docker y Docker Compose instalados**
2. **KyberCore funcionando correctamente con V1**
3. **Acceso a los logs del contenedor**
4. **Navegador moderno** (Chrome/Firefox/Edge)

### Backup

Antes de proceder, haz backup de:

```bash
# Backup de la configuraci√≥n actual
cp .env .env.backup

# Backup de la base de datos (si aplica)
cp -r base_datos/ base_datos_backup/

# Backup de los archivos subidos
cp -r /tmp/kybercore/ /tmp/kybercore_backup/
```

---

## Instalaci√≥n y Configuraci√≥n

### Paso 1: Actualizar C√≥digo

```bash
cd /home/elisaul77/KyberCore

# Aseg√∫rate de tener la √∫ltima versi√≥n
git pull origin main

# O si trabajas en una rama espec√≠fica
git pull origin feature/backend-centric-rotation
```

### Paso 2: Configurar Variables de Entorno

El archivo `.env` ya debe existir. Verifica/ajusta estos par√°metros:

```bash
# Editar el archivo .env
nano .env
```

**Par√°metros clave para V2:**

```env
# N√∫mero de archivos procesados en paralelo (recomendado: 3-5)
ROTATION_WORKER_POOL_SIZE=3

# N√∫mero de reintentos por archivo (recomendado: 3)
ROTATION_MAX_RETRIES=3

# Tiempo entre reintentos en segundos (recomendado: 2)
ROTATION_RETRY_DELAY=2

# Timeout para operaciones de red (recomendado: 60)
ROTATION_TIMEOUT_SECONDS=60

# Habilitar V2 por defecto (true)
ENABLE_BACKEND_ROTATION=true
```

**Ajustes seg√∫n hardware:**

| Escenario | POOL_SIZE | MAX_RETRIES | RETRY_DELAY |
|-----------|-----------|-------------|-------------|
| **Raspberry Pi 4** | 2 | 3 | 3 |
| **PC normal** | 3 | 3 | 2 |
| **Servidor potente** | 5 | 3 | 1 |
| **Red inestable** | 2 | 5 | 5 |

### Paso 3: Instalar Dependencias

```bash
# Instalar python-dotenv (nueva dependencia)
pip install -r requirements.txt

# O si usas Docker (recomendado)
docker compose down
docker compose up --build -d
```

### Paso 4: Verificar Logs de Inicio

```bash
# Ver los logs para confirmar que carg√≥ la configuraci√≥n
docker compose logs -f kybercore

# Deber√≠as ver algo como:
# ‚úÖ Variables de entorno cargadas desde: /app/.env
# üöÄ Iniciando KyberCore...
# üîß RotationWorker inicializado: pool_size=3, max_retries=3
```

---

## Activaci√≥n de V2

### Opci√≥n A: Activar Globalmente (Recomendado)

V2 est√° **activado por defecto** si `ENABLE_BACKEND_ROTATION=true` en `.env`.

No necesitas hacer nada adicional - todos los usuarios usar√°n V2 autom√°ticamente.

### Opci√≥n B: Activar por Usuario (Testing)

Si quieres que solo algunos usuarios prueben V2:

1. **Abrir la aplicaci√≥n en el navegador**
2. **Abrir DevTools** (F12)
3. **Ir a la pesta√±a "Console"**
4. **Ejecutar:**

```javascript
// Activar V2 para este navegador
localStorage.setItem('use_backend_rotation', 'true');

// Recargar la p√°gina
location.reload();
```

5. **Verificar en la consola:**

```
üîß Modo de procesamiento: V2 (Backend-Centric: true)
```

6. **El bot√≥n mostrar√°:** "Iniciar Procesamiento (V2)"

---

## Verificaci√≥n

### Paso 1: Verificar la UI

1. Abre un proyecto en la galer√≠a
2. Ve al modal de nuevo trabajo
3. Completa los pasos hasta "Procesamiento"
4. El bot√≥n debe decir: **"Iniciar Procesamiento (V2)"**

### Paso 2: Procesar Archivos

1. Haz clic en "Iniciar Procesamiento (V2)"
2. **Deber√≠as ver:**
   - Mensaje: "Procesando archivos en el servidor..."
   - **Progress bar animado**
   - **Porcentaje de progreso** (0% ‚Üí 100%)
   - Menos flickering que V1

### Paso 3: Verificar Logs del Backend

```bash
# Ver logs en tiempo real
docker compose logs -f kybercore

# Buscar logs del RotationWorker
docker compose logs kybercore | grep "RotationWorker"
```

**Deber√≠as ver algo como:**

```
üîÑ [RotationWorker] Iniciando procesamiento de 10 archivos...
üîÑ [RotationWorker] Procesando lote (3 workers en paralelo)
‚úÖ [RotationWorker] cube.stl ‚Üí rotado exitosamente (intento 1/3)
‚úÖ [RotationWorker] sphere.stl ‚Üí rotado exitosamente (intento 1/3)
‚úÖ [RotationWorker] pyramid.stl ‚Üí rotado exitosamente (intento 1/3)
üìä [RotationWorker] Progreso: 30.0% (3/10 archivos completados)
...
‚úÖ [RotationWorker] Procesamiento completado: 10/10 exitosos, 0 fallos
```

### Paso 4: Verificar Performance

Con **DevTools Network** (F12 ‚Üí Network):

**V1:**
- Ver√°s ~30 requests a `/api/gallery/download-stl`, `/auto-rotate-upload`, `/save-rotated-stl`
- Requests secuenciales (una tras otra)

**V2:**
- Ver√°s **1 request inicial** a `/api/print/process-with-rotation`
- Luego **requests de polling** cada 2s a `/api/print/task-status/{id}`
- Menos tr√°fico total, m√°s limpio

### Paso 5: Validaci√≥n Funcional

1. Despu√©s del procesamiento, verifica que:
   - Todos los archivos tienen ‚úÖ verde
   - Puedes avanzar al paso de "Validaci√≥n"
   - Los archivos rotados se ven correctos en la previsualizaci√≥n
   - Puedes completar el wizard sin errores

---

## Rollback a V1

Si algo no funciona correctamente, puedes volver a V1 inmediatamente:

### Rollback por Usuario (Inmediato)

```javascript
// En la consola del navegador (F12)
localStorage.setItem('use_backend_rotation', 'false');
location.reload();
```

El bot√≥n ahora dir√°: **"Iniciar Procesamiento (V1)"**

### Rollback Global (Todos los Usuarios)

1. Editar `.env`:

```env
ENABLE_BACKEND_ROTATION=false
```

2. Reiniciar el contenedor:

```bash
docker compose restart kybercore
```

3. Verificar en logs:

```bash
docker compose logs kybercore | grep "backend rotation"
```

---

## Monitoreo y Troubleshooting

### Problema: El bot√≥n no muestra "(V2)"

**S√≠ntomas:**
- El bot√≥n dice "Iniciar Procesamiento" sin versi√≥n

**Soluci√≥n:**
```javascript
// Verificar qu√© versi√≥n est√° activa
console.log(localStorage.getItem('use_backend_rotation'));

// Si retorna null o undefined, activar expl√≠citamente
localStorage.setItem('use_backend_rotation', 'true');
location.reload();
```

### Problema: Timeout despu√©s de 10 minutos

**S√≠ntomas:**
- El procesamiento se detiene despu√©s de mucho tiempo
- Mensaje: "Timeout: procesamiento tom√≥ m√°s de 10 minutos"

**Soluci√≥n:**

1. Revisa los logs del backend:
```bash
docker compose logs kybercore | tail -100
```

2. Posibles causas:
   - APISLICER no responde ‚Üí verificar con `docker compose ps`
   - Archivos STL muy grandes ‚Üí reducir `ROTATION_WORKER_POOL_SIZE`
   - Red lenta ‚Üí aumentar `ROTATION_TIMEOUT_SECONDS`

### Problema: Algunos archivos fallan

**S√≠ntomas:**
- El proceso completa pero algunos archivos tienen ‚ùå

**Soluci√≥n:**

1. Ver el error espec√≠fico:
```bash
# En los logs del backend
docker compose logs kybercore | grep "ERROR\|FAILED"
```

2. Verificar APISLICER:
```bash
# Verificar que APISLICER est√© activo
curl http://localhost:5000/health

# Reiniciar APISLICER si es necesario
docker compose restart apislicer
```

3. Aumentar reintentos temporalmente:
```env
ROTATION_MAX_RETRIES=5
ROTATION_RETRY_DELAY=3
```

### Problema: Procesamiento muy lento

**S√≠ntomas:**
- V2 es m√°s lento que V1 (no deber√≠a pasar)

**Diagn√≥stico:**

1. Verificar configuraci√≥n:
```bash
cat .env | grep ROTATION
```

2. Ajustar seg√∫n hardware:
```env
# Si tienes buena CPU/RAM
ROTATION_WORKER_POOL_SIZE=5

# Si la red es el cuello de botella
ROTATION_WORKER_POOL_SIZE=2
ROTATION_TIMEOUT_SECONDS=90
```

3. Verificar logs de tiempos:
```bash
docker compose logs kybercore | grep "Tiempo total"
```

### Logs √ötiles

**Ver solo logs de rotaci√≥n:**
```bash
docker compose logs kybercore | grep "RotationWorker"
```

**Ver errores:**
```bash
docker compose logs kybercore | grep "ERROR\|‚ùå"
```

**Ver m√©tricas de performance:**
```bash
docker compose logs kybercore | grep "Progreso:\|Tiempo total:"
```

**Ver actividad de un task espec√≠fico:**
```bash
# Reemplaza {task_id} con el ID real
docker compose logs kybercore | grep "{task_id}"
```

---

## FAQ

### ¬øPuedo usar V1 y V2 al mismo tiempo?

**S√≠.** El sistema es totalmente compatible hacia atr√°s:
- Algunos usuarios pueden usar V1
- Otros usuarios pueden usar V2
- Se controla v√≠a `localStorage` por navegador

### ¬øQu√© pasa si cierro el navegador durante el procesamiento?

**V2:** El procesamiento **contin√∫a en el backend**. Al reabrir:
- Si el task sigue activo, puedes seguir haciendo polling
- Si ya termin√≥, ver√°s el resultado inmediatamente

**V1:** El procesamiento **se detiene** porque todo pasa en el frontend.

### ¬øCu√°nto espacio adicional usa V2?

**Casi nada.** Los archivos rotados se guardan en `/tmp/` igual que en V1. La √∫nica diferencia es:
- Los objetos `TaskStatus` en memoria (~1-2 KB por task)
- Se limpian autom√°ticamente despu√©s de 1 hora

### ¬øV2 consume m√°s CPU?

**No.** El trabajo total es el mismo, solo cambia qui√©n lo hace:
- **V1:** El navegador descarga ‚Üí el backend procesa
- **V2:** El backend lee del disco ‚Üí el backend procesa

V2 puede ser **m√°s eficiente** porque evita m√∫ltiples transferencias de red.

### ¬øDebo actualizar APISLICER tambi√©n?

**No.** V2 usa los mismos endpoints de APISLICER que V1:
- `/auto-rotate-upload`
- `/slice`

No hay cambios necesarios en APISLICER.

### ¬øPuedo configurar diferentes POOL_SIZE para diferentes usuarios?

**No directamente.** El `ROTATION_WORKER_POOL_SIZE` es global para todos los usuarios.

Sin embargo, podr√≠as:
1. Crear m√∫ltiples instancias de KyberCore con diferentes configuraciones
2. Usar un load balancer para dirigir usuarios a diferentes instancias

### ¬øV2 funciona con archivos muy grandes (>100MB)?

**S√≠**, pero puede requerir ajustes:

```env
# Aumentar timeouts
ROTATION_TIMEOUT_SECONDS=180

# Reducir paralelizaci√≥n para evitar OOM
ROTATION_WORKER_POOL_SIZE=1

# Aumentar l√≠mite de upload (si aplica)
MAX_UPLOAD_SIZE_MB=500
```

### ¬øC√≥mo puedo ver el progreso en tiempo real m√°s detallado?

Actualmente el frontend muestra **porcentaje global** (ej: 30%).

Para ver **progreso por archivo**, abre DevTools y ve a Network ‚Üí busca las respuestas de `/task-status/{id}`:

```json
{
  "progress": {
    "total_files": 10,
    "completed": 3,
    "failed": 0,
    "percentage": 30.0
  },
  "results": [
    {"filename": "cube.stl", "success": true, "rotated_path": "..."},
    {"filename": "sphere.stl", "success": true, "rotated_path": "..."},
    {"filename": "pyramid.stl", "success": true, "rotated_path": "..."}
  ]
}
```

### ¬øCu√°ndo deber√≠a usar V1 en lugar de V2?

Usa V1 solo si:
1. **Est√°s debuggeando** y necesitas ver cada paso individual
2. **Tienes problemas con V2** que no has podido resolver
3. **Tu backend tiene recursos muy limitados** (ej: Raspberry Pi Zero)

En general, **V2 es superior en todos los aspectos**.

---

## Soporte

Si tienes problemas:

1. **Revisa esta gu√≠a** y el documento t√©cnico en `docs/architecture/auto_rotacion_arquitectura.md`
2. **Revisa los logs**: `docker compose logs -f kybercore`
3. **Intenta rollback a V1** para confirmar que no es un problema general
4. **Reporta el issue** con:
   - Versi√≥n de KyberCore
   - Configuraci√≥n de `.env` (sin passwords)
   - Logs relevantes
   - Pasos para reproducir

---

**üéâ ¬°Disfruta de la nueva arquitectura V2!**

Creado: $(date)
√öltima actualizaci√≥n: $(date)
